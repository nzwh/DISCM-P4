version: '3.8'

services:
  # Frontend Node - Next.js Application
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_SUPABASE_URL: ${SUPABASE_URL}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
        COURSE_SERVICE_URL: ${COURSE_SERVICE_URL:-localhost:4001}
        ENROLL_SERVICE_URL: ${ENROLL_SERVICE_URL:-localhost:4002}
        GRADE_SERVICE_URL: ${GRADE_SERVICE_URL:-localhost:4003}
    env_file:
      - .env
    environment:
      - NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - COURSE_SERVICE_URL=${COURSE_SERVICE_URL:-localhost:4001}
      - ENROLL_SERVICE_URL=${ENROLL_SERVICE_URL:-localhost:4002}
      - GRADE_SERVICE_URL=${GRADE_SERVICE_URL:-localhost:4003}
    ports:
      - "3000:3000"
    depends_on:
      - course-service
      - enroll-service
      - grade-service
    networks:
      - enrollment-network
    restart: unless-stopped

  # Course Service - Handles course management
  course-service:
    build:
      context: ./services/course-service
      dockerfile: Dockerfile
    ports:
      - "4001:4001"
    environment:
      - PORT=4001
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - NODE_ENV=production
    networks:
      - enrollment-network
    restart: unless-stopped
    # Health check via gRPC (services have HealthCheck method)
    # Note: Docker health checks require HTTP, so health checks are disabled
    # Services can be checked via gRPC HealthCheck method

  # Enrollment Service - Handles student enrollments
  enroll-service:
    build:
      context: ./services/enroll-service
      dockerfile: Dockerfile
    ports:
      - "4002:4002"
    environment:
      - PORT=4002
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - NODE_ENV=production
    networks:
      - enrollment-network
    restart: unless-stopped
    # Health check via gRPC (services have HealthCheck method)
    # Note: Docker health checks require HTTP, so health checks are disabled
    # Services can be checked via gRPC HealthCheck method

  # Grade Service - Handles grade management
  grade-service:
    build:
      context: ./services/grade-service
      dockerfile: Dockerfile
    ports:
      - "4003:4003"
    environment:
      - PORT=4003
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - NODE_ENV=production
    networks:
      - enrollment-network
    restart: unless-stopped
    # Health check via gRPC (services have HealthCheck method)
    # Note: Docker health checks require HTTP, so health checks are disabled
    # Services can be checked via gRPC HealthCheck method

networks:
  enrollment-network:
    driver: bridge